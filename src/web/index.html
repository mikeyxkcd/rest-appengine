<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">

<link rel="stylesheet/less" type="text/css" href="web/styles.less">
<script src="web/less-1.3.0.min.js" type="text/javascript"></script>
<script src="http://code.jquery.com/jquery-1.7.2.min.js" type="text/javascript"></script>
<script src="web/underscore-min.js" type="text/javascript"></script>
<script src="web/backbone-min.js" type="text/javascript"></script>
<script src="web/bootstrap/js/bootstrap-typeahead.js" type="text/javascript"></script>
<script src="web/bootstrap/js/bootstrap-modal.js" type="text/javascript"></script>

<script type="text/template" id="list-element">
<td><%=key%></td><td> :</td> <td><%=value%></td><td> <button class="doSomething btn-small">Delete</button></td>
</script>

<script type="text/template" id="entity-body">
    <table class="table table-striped">
    <tr><th>Property Name</th><th>Property Value</th></tr>
    <% for (property in attributes){%>
    <tr>
    <td><%print(property)%></td><td><%print(attributes[property])%></td>
    </tr>
    <% } %>
    </table>
    <input placeholder="Property Name" class="key"> <div class="control-group"><div class="controls"><input placeholder="Value" class="value" data-provide="typeahead"></div> </div> <button type="button" class="btn add-property">Add</button><br>
    <button type="button" class="btn btn-large btn-primary save">Save</button><button type="button" class="btn btn-danger btn-large delete">Delete</button><button type="button" class="btn btn-information btn-large retrieve">Retrieve</button>
</script>

<script type="text/html" id="modal-body">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">Ã—</a>
    <h3>Enter name</h3>
  </div>
  <div class="modal-body">
    <input type="text">
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-primary">OK</button>
  </div>
</script>

<script type="text/javascript">

ModalNamer = Backbone.View.extend({
    initialize: function(){
        this.render();
    },
    tagName: 'div',
    className: 'modal',    
    render: function(){
        this.el.innerHTML = $('#modal-body').html();
        var nameInput = this.$('input');
        this.$el.on('shown', _.bind(function (event) {
            nameInput.focus()},this));
    },
    events: {"click button": "allDone",
    "keypress input": function(event){
        if (event.which == 13)
        {
        	this.allDone();
       	}
    }},
    allDone: function(){
    	var newWidget = new EntityWidget({model:new ModelEntity({__type:this.$('input').val()})});
        $('body').append(newWidget.el);
        this.$el.modal('hide');
    }
})

ModelEntity = Backbone.Model.extend({
	   initialize:function(options){
		   this.on('change:__id',function(){
			    this.id = this.get('__id');   
		   });
	    }
});

EntityWidget = Backbone.View.extend({
	initialize:function(options){
        this.render();
        this.model.on('change', function(){this.render()}, this);

	},
	tagName:'div',
    events: {"click .add-property":function(){
        this.add();
    }, 
    "click .save":function(){
        this.model.save();
    }, 
    "click .retrieve":function(){
        this.model.fetch();
    }, 
    "click .delete":function(){
        this.model.destroy();
    }, 
    "keypress .value":function(event){
    	if (event.which == 13)
    	{
    	    this.add();
    		return false;
    	}
    },
     "change .value":function(event){
    	var currentText = event.target.value;
        if (currentText=="null" || currentText=="true" || currentText=="false" || currentText=="here" || currentText=="now")
        {
        	this.$('.control-group').addClass("success");
        }
        else
        {
        	this.$('.control-group').removeClass("success");
       	}
    },
    "input .value":function(event){
        var currentText = event.target.value;
        if (currentText=="null" || currentText=="true" || currentText=="false" || currentText=="here" || currentText=="now")
        {
            this.$('.control-group').addClass("success");
        }
        else
        {
            this.$('.control-group').removeClass("success");
        }

    }},
    add:function()
    {
    	result = this.$('.value').val();
    	if (result=="null")
    		result = null;
    	else if(result=="true")
    		result = true;
    	else if(result =="false")
    	    result = false;		
    	else if(result=="here")
    	{
    		result = latitude.toString()+ "," + longitude.toString();
    	}    		
    	else if(result=="now")
    	{
    		result = new Date().toISOString();
    	}
    	else if(/\d+/.test(result))
    	{
    	    result = parseInt(result);		
    	}
        else if(/\d*\.\d+/.test(result))
        {
            result = parseFloat(result);      
        }
        this.model.set(this.$('.key').val(), result);
    },
    render: function(){
        this.el.innerHTML =_.template($('#entity-body').html(), {attributes:this.model.attributes});
        var typeOptions = ['null', 'true', 'false', 'here', 'now'];
        var something1 = this.$('.value').typeahead({source: typeOptions});
        this.$('.key').focus();
    }
})

Backbone.sync = function(method, model) {
	if (method == "create" || method=="update")
	{
	    var readyForJSON = JSON.stringify(model);
	    $.ajax({type:"POST",contentType:"application/json", data:readyForJSON,url:'/api',success:function(data, textStatus, jqXHR){
	        model.set("__id",parseInt(data));	    	
	    }});
	}
	else if (method=="delete")
	{
	      $.ajax({type:"DELETE",url:'/api/'+model.get('__type')+'/'+model.get('__id')});
	}
	else
	{
        $.ajax({url:'/api/'+model.get('__type')+'/'+model.get('__id'), success:function(data, textStatus, jqXHR){        	
            model.set(data);   
        }

        });
	}
		
};

var latitude,longitude;

//JQuery to english: 'When the page is done loading, perform this function'
$(function(){
	//This creates a new form and inserts it into the body
	//Register this listener so that new entities will be created on button click
	$('#add-new-entity').click(function(event){
		//Create a new model object
		new ModalNamer().$el.modal('show');
	});
	
    navigator.geolocation.getCurrentPosition(function (position) {
        latitude = position.coords.latitude;
        longitude = position.coords.longitude
    });

});

</script>  

<title>Manage Dreamiam</title>

</head>
<body>
    <button type="button" class="btn-primary" id="add-new-entity">+</button>
</body>
</html>